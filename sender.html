<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADAM Signage - Sender</title>
<script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #1a1a1a;
  color: #f8f9fa;
  margin: 0;
  padding: 2rem;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
}
h1 {
  color: #0d6efd;
  margin-bottom: 2rem;
}
.section {
  background: #2d2d2d;
  padding: 1.5rem;
  border-radius: 12px;
  margin-bottom: 1.5rem;
  border: 1px solid #404040;
}
.section h2 {
  margin-top: 0;
  color: #6f42c1;
}
input[type="text"], select, input[type="datetime-local"] {
  width: 100%;
  padding: 0.75rem;
  margin: 0.5rem 0;
  background: rgba(255,255,255,0.1);
  border: 2px solid #404040;
  border-radius: 8px;
  color: white;
  font-size: 1rem;
}
button {
  padding: 0.75rem 1.5rem;
  background: #0d6efd;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  margin: 0.5rem 0.5rem 0.5rem 0;
  transition: all 0.2s ease;
}
button:hover {
  background: #0b5ed7;
  transform: translateY(-1px);
}
.cast-btn {
  background: #198754;
}
.cast-btn:hover {
  background: #157347;
}
#castStatus {
  padding: 1rem;
  background: rgba(13,110,253,0.1);
  border-left: 4px solid #0d6efd;
  margin: 1rem 0;
  border-radius: 4px;
}
.security-warning {
  background: #fff3cd;
  color: #856404;
  padding: 1rem;
  border-radius: 8px;
  margin: 1rem 0;
  border: 1px solid #ffeaa7;
}
.remote-config, .playlist-editor, .schedule-panel {
  margin-top: 1rem;
  padding: 1rem;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
}
.grid-input {
  margin-bottom: 0.5rem;
  display: flex;
  gap: 0.5rem;
  align-items: center;
}
.grid-input input {
  flex: 1;
}
.playlist-item {
  padding: 0.75rem;
  background: #333;
  margin: 0.5rem 0;
  border-radius: 6px;
  border-left: 4px solid #0d6efd;
}
</style>
</head>
<body>
<div class="container">
  <h1>ADAM Signage - Cast Sender</h1>
  
  <div id="castStatus">
    Status: <span id="status">Not connected</span>
  </div>

  <div class="security-warning">
    <p><strong>Security Notice:</strong> This application can cast to Google TV devices on your local network and remote devices with proper configuration. 
    Ensure your network is secure when enabling remote access.</p>
  </div>

  <div class="section">
    <h2>Cast Single Content</h2>
    <input type="text" id="singleUrl" placeholder="Enter URL (YouTube, image, video)">
    <button class="cast-btn" onclick="castSingle()">Cast Single Content</button>
  </div>

  <div class="section">
    <h2>Cast to 9x9 Grid</h2>
    <div id="gridInputs"></div>
    <button onclick="addGridInput()">Add URL</button>
    <button class="cast-btn" onclick="castGrid()">Cast to 9x9 Grid</button>
  </div>

  <!-- Playlist Management -->
  <div class="section">
    <h2>Content Library & Playlists</h2>
    <div>
      <input type="text" id="libraryUrl" placeholder="Add URL to library">
      <button onclick="addToLibrary()">Add to Library</button>
    </div>
    <select id="playlistSelect" style="width: auto; margin: 0.5rem 0;">
      <option value="">Select Playlist</option>
      <option value="morning">Morning Display</option>
      <option value="evening">Evening Display</option>
    </select>
    <button onclick="loadPlaylist()">Load</button>
    <button onclick="savePlaylist()">Save</button>
  </div>

  <!-- Scheduling -->
  <div class="section">
    <h2>Scheduled Casting</h2>
    <div class="schedule-panel">
      <input type="text" id="scheduleName" placeholder="Schedule Name">
      <input type="datetime-local" id="startTime" placeholder="Start Time">
      <input type="datetime-local" id="endTime" placeholder="End Time">
      <select id="targetZone">
        <option value="all">All Devices</option>
        <option value="lobby">Lobby Screens</option>
        <option value="factory">Factory Floor</option>
      </select>
      <button class="cast-btn" onclick="scheduleCast()">Schedule Cast</button>
    </div>
  </div>

  <div class="section">
    <h2>Cast Controls</h2>
    <button onclick="initializeCast()">Initialize Cast</button>
    <button onclick="stopCasting()">Stop Casting</button>
  </div>

  <div class="section">
    <h2>Remote Device Configuration</h2>
    <div class="remote-config">
      <div>
        <label>Remote Device Hostname/IP:</label>
        <input type="text" id="remoteHost" placeholder="e.g., mytv.ddns.net or 123.45.67.89">
      </div>
      <div>
        <label>Port (default 8008):</label>
        <input type="number" id="remotePort" value="8008" min="1" max="65535">
      </div>
      <button onclick="connectToRemote()">Connect to Remote Device</button>
    </div>
  </div>
</div>

<script>
let castSession = null;
let contentLibrary = JSON.parse(localStorage.getItem('adamLibrary') || '[]');
let currentPlaylist = [];

// Initialize Cast Framework
window['__onGCastApiAvailable'] = function(isAvailable) {
  if (isAvailable) {
    initializeCastApi();
  }
};

function initializeCastApi() {
  const context = cast.framework.CastContext.getInstance();
  context.setOptions({
    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
  });

  context.addEventListener(
    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
    (event) => {
      switch (event.sessionState) {
        case cast.framework.SessionState.SESSION_STARTED:
          castSession = event.session;
          document.getElementById('status').textContent = 'Connected';
          console.log('Cast session started');
          break;
        case cast.framework.SessionState.SESSION_ENDED:
          castSession = null;
          document.getElementById('status').textContent = 'Not connected';
          console.log('Cast session ended');
          break;
      }
    }
  );
}

function initializeCast() {
  const context = cast.framework.CastContext.getInstance();
  context.requestSession().then(
    () => {
      console.log('Cast session request successful');
    },
    (error) => {
      console.error('Error requesting cast session:', error);
      alert('Error connecting to device. Check that your Google TV is on the same network and Chromecast is enabled.');
    }
  );
}

function castSingle() {
  const url = document.getElementById('singleUrl').value.trim();
  if (!url) {
    alert('Please enter a URL');
    return;
  }

  if (!castSession) {
    alert('No cast session. Please initialize cast first.');
    return;
  }

  const mediaInfo = new chrome.cast.media.MediaInfo(url, 'video/mp4');
  const request = new chrome.cast.media.LoadRequest(mediaInfo);

  castSession.loadMedia(request).then(
    () => {
      console.log('Media loaded successfully');
      alert('Content cast successfully!');
    },
    (error) => {
      console.error('Error loading media:', error);
      alert('Error casting content. Check the URL format and ensure the content is accessible.');
    }
  );
}

function castGrid() {
  const inputs = document.querySelectorAll('#gridInputs input');
  const urls = [];
  
  inputs.forEach(input => {
    if (input.value.trim()) {
      urls.push(input.value.trim());
    }
  });

  if (urls.length === 0) {
    alert('Please add at least one URL');
    return;
  }

  if (!castSession) {
    alert('No cast session. Please initialize cast first.');
    return;
  }

  const customData = {
    gridMode: 'pip9x9',
    urls: urls,
    timestamp: new Date().toISOString()
  };

  const mediaInfo = new chrome.cast.media.MediaInfo(
    window.location.origin + '/receiver.html',
    'text/html'
  );
  
  const request = new chrome.cast.media.LoadRequest(mediaInfo);
  request.customData = customData;

  castSession.loadMedia(request).then(
    () => {
      console.log('Grid loaded successfully');
      alert(`Grid cast successfully with ${urls.length} sources!`);
    },
    (error) => {
      console.error('Error loading grid:', error);
      alert('Error casting grid. Ensure receiver.html is properly hosted and accessible.');
    }
  );
}

function stopCasting() {
  if (castSession) {
    castSession.endSession(true);
  }
}

function addGridInput() {
  const container = document.getElementById('gridInputs');
  const index = container.children.length;
  const div = document.createElement('div');
  div.className = 'grid-input';
  div.innerHTML = `
    <input type="text" placeholder="URL for Tile ${index + 1}">
    <button onclick="this.parentElement.remove()" style="width:40px">✕</button>
  `;
  container.appendChild(div);
}

function connectToRemote() {
  const host = document.getElementById('remoteHost').value.trim();
  const port = document.getElementById('remotePort').value;
  
  if (!host) {
    alert('Please enter a hostname or IP address');
    return;
  }
  
  const context = cast.framework.CastContext.getInstance();
  context.setOptions({
    receiverApplicationId: 'YOUR_CUSTOM_APP_ID',
    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
  });
  
  initializeCast();
  alert('Attempting to connect to remote device. Ensure remote access is enabled on your Google TV and the network is properly configured.');
}

// Content Library Functions
function addToLibrary() {
  const url = document.getElementById('libraryUrl').value.trim();
  if (!url) {
    alert('Enter a URL to add to library');
    return;
  }
  
  if (!contentLibrary.includes(url)) {
    contentLibrary.push(url);
    localStorage.setItem('adamLibrary', JSON.stringify(contentLibrary));
    alert('URL added to library!');
    document.getElementById('libraryUrl').value = '';
  }
}

// Playlist Functions
function savePlaylist() {
  const playlistName = prompt('Enter playlist name:');
  if (!playlistName) return;
  
  const playlistData = {
    name: playlistName,
    urls: currentPlaylist,
    savedAt: new Date().toISOString()
  };
  
  localStorage.setItem(`adamPlaylist_${playlistName}`, JSON.stringify(playlistData));
  alert(`Playlist "${playlistName}" saved!`);
  
  // Update dropdown
  const select = document.getElementById('playlistSelect');
  const option = document.createElement('option');
  option.value = playlistName;
  option.textContent = playlistName;
  select.appendChild(option);
}

function loadPlaylist() {
  const select = document.getElementById('playlistSelect');
  const name = select.value;
  if (!name) {
    alert('Select a playlist to load');
    return;
  }
  
  const saved = localStorage.getItem(`adamPlaylist_${name}`);
  if (saved) {
    const data = JSON.parse(saved);
    currentPlaylist = data.urls;
    
    // Clear and repopulate grid inputs
    const container = document.getElementById('gridInputs');
    container.innerHTML = '';
    
    data.urls.forEach(url => {
      const div = document.createElement('div');
      div.className = 'grid-input';
      div.innerHTML = `
        <input type="text" value="${url}" placeholder="URL for Tile">
        <button onclick="this.parentElement.remove()" style="width:40px">✕</button>
      `;
      container.appendChild(div);
    });
    
    alert(`Playlist "${name}" loaded!`);
  }
}

// Scheduling Function
function scheduleCast() {
  const name = document.getElementById('scheduleName').value.trim();
  const start = document.getElementById('startTime').value;
  const end = document.getElementById('endTime').value;
  const zone = document.getElementById('targetZone').value;
  
  if (!name || !start || !end) {
    alert('Please fill all schedule fields');
    return;
  }
  
  const schedule = {
    name,
    start,
    end,
    zone,
    gridUrls: Array.from(document.querySelectorAll('#gridInputs input')).map(i => i.value).filter(v => v),
    scheduledAt: new Date().toISOString()
  };
  
  // Save to localStorage
  const schedules = JSON.parse(localStorage.getItem('adamSchedules') || '[]');
  schedules.push(schedule);
  localStorage.setItem('adamSchedules', JSON.stringify(schedules));
  
  alert(`Schedule "${name}" created! It will run from ${start} to ${end} on ${zone}`);
}

// Initialize with 3 inputs
for (let i = 0; i < 3; i++) {
  addGridInput();
}

// Load library and playlists on startup
window.onload = function() {
  // Load saved playlists into dropdown
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('adamPlaylist_')) {
      const name = key.replace('adamPlaylist_', '');
      const select = document.getElementById('playlistSelect');
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      select.appendChild(option);
    }
  }
};
</script>
</body>
</html>
