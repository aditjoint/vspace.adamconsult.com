<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADAM Signage - Sender</title>
<script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #1a1a1a;
  color: #f8f9fa;
  margin: 0;
  padding: 2rem;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
}
h1 {
  color: #0d6efd;
  margin-bottom: 2rem;
}
.section {
  background: #2d2d2d;
  padding: 1.5rem;
  border-radius: 12px;
  margin-bottom: 1.5rem;
  border: 1px solid #404040;
}
.section h2 {
  margin-top: 0;
  color: #6f42c1;
}
input[type="text"], select, input[type="datetime-local"] {
  width: 100%;
  padding: 0.75rem;
  margin: 0.5rem 0;
  background: rgba(255,255,255,0.1);
  border: 2px solid #404040;
  border-radius: 8px;
  color: white;
  font-size: 1rem;
}
button {
  padding: 0.75rem 1.5rem;
  background: #0d6efd;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  margin: 0.5rem 0.5rem 0.5rem 0;
  transition: all 0.2s ease;
}
button:hover {
  background: #0b5ed7;
  transform: translateY(-1px);
}
.cast-btn {
  background: #198754;
}
.cast-btn:hover {
  background: #157347;
}
#castStatus {
  padding: 1rem;
  background: rgba(13,110,253,0.1);
  border-left: 4px solid #0d6efd;
  margin: 1rem 0;
  border-radius: 4px;
}
.security-warning {
  background: #fff3cd;
  color: #856404;
  padding: 1rem;
  border-radius: 8px;
  margin: 1rem 0;
  border: 1px solid #ffeaa7;
}
.remote-config, .playlist-editor, .schedule-panel {
  margin-top: 1rem;
  padding: 1rem;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
}
.grid-input {
  margin-bottom: 0.5rem;
  display: flex;
  gap: 0.5rem;
  align-items: center;
}
.grid-input input {
  flex: 1;
}
.playlist-item {
  padding: 0.75rem;
  background: #333;
  margin: 0.5rem 0;
  border-radius: 6px;
  border-left: 4px solid #0d6efd;
}
.content-preview {
  margin-top: 1rem;
  padding: 1rem;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  min-height: 100px;
}
.content-preview img, .content-preview video {
  max-width: 100%;
  max-height: 200px;
  border-radius: 4px;
}
</style>
</head>
<body>
<div class="container">
  <h1>ADAM Signage - Cast Sender</h1>
  
  <div id="castStatus">
    Status: <span id="status">Not connected</span>
  </div>

  <div class="security-warning">
    <p><strong>Security Notice:</strong> This application can cast to Google TV devices on your local network and remote devices with proper configuration. 
    Ensure your network is secure when enabling remote access.</p>
  </div>

  <div class="section">
    <h2>Cast Single Content</h2>
    <input type="text" id="singleUrl" placeholder="Enter URL (YouTube, image, video)">
    <div class="content-preview" id="contentPreview">
      <p>Content preview will appear here</p>
    </div>
    <button class="cast-btn" onclick="castSingle()">Cast Single Content</button>
  </div>

  <div class="section">
    <h2>Cast to 9x9 Grid</h2>
    <div id="gridInputs"></div>
    <button onclick="addGridInput()">Add URL</button>
    <button class="cast-btn" onclick="castGrid()">Cast to 9x9 Grid</button>
  </div>

  <!-- Playlist Management -->
  <div class="section">
    <h2>Content Library & Playlists</h2>
    <div>
      <select id="contentLibrary" style="width: auto; margin: 0.5rem 0;">
        <option value="">Select from Library</option>
      </select>
      <button onclick="loadFromLibrary()">Load to Grid</button>
    </div>
    <select id="playlistSelect" style="width: auto; margin: 0.5rem 0;">
      <option value="">Select Playlist</option>
    </select>
    <button onclick="loadPlaylist()">Load</button>
    <button onclick="savePlaylist()">Save</button>
  </div>

  <!-- Scheduling -->
  <div class="section">
    <h2>Scheduled Casting</h2>
    <div class="schedule-panel">
      <input type="text" id="scheduleName" placeholder="Schedule Name">
      <input type="datetime-local" id="startTime" placeholder="Start Time">
      <input type="datetime-local" id="endTime" placeholder="End Time">
      <select id="targetZone">
        <option value="all">All Devices</option>
      </select>
      <button class="cast-btn" onclick="scheduleCast()">Schedule Cast</button>
    </div>
  </div>

  <div class="section">
    <h2>Cast Controls</h2>
    <button onclick="initializeCast()">Initialize Cast</button>
    <button onclick="stopCasting()">Stop Casting</button>
  </div>

  <div class="section">
    <h2>Remote Device Configuration</h2>
    <div class="remote-config">
      <div>
        <label>Remote Device Hostname/IP:</label>
        <input type="text" id="remoteHost" placeholder="e.g., mytv.ddns.net or 123.45.67.89">
      </div>
      <div>
        <label>Port (default 8008):</label>
        <input type="number" id="remotePort" value="8008" min="1" max="65535">
      </div>
      <button onclick="connectToRemote()">Connect to Remote Device</button>
    </div>
  </div>
</div>

<script>
let castSession = null;
let contentLibrary = [];
let playlists = [];
let zones = [];
let currentPlaylist = [];

// Initialize Cast Framework
window['__onGCastApiAvailable'] = function(isAvailable) {
  if (isAvailable) {
    initializeCastApi();
  }
};

function initializeCastApi() {
  const context = cast.framework.CastContext.getInstance();
  context.setOptions({
    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
  });

  context.addEventListener(
    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
    (event) => {
      switch (event.sessionState) {
        case cast.framework.SessionState.SESSION_STARTED:
          castSession = event.session;
          document.getElementById('status').textContent = 'Connected';
          console.log('Cast session started');
          break;
        case cast.framework.SessionState.SESSION_ENDED:
          castSession = null;
          document.getElementById('status').textContent = 'Not connected';
          console.log('Cast session ended');
          break;
      }
    }
  );
}

function initializeCast() {
  const context = cast.framework.CastContext.getInstance();
  context.requestSession().then(
    () => {
      console.log('Cast session request successful');
    },
    (error) => {
      console.error('Error requesting cast session:', error);
      alert('Error connecting to device. Check that your Google TV is on the same network and Chromecast is enabled.');
    }
  );
}

function castSingle() {
  const url = document.getElementById('singleUrl').value.trim();
  if (!url) {
    alert('Please enter a URL');
    return;
  }

  if (!castSession) {
    alert('No cast session. Please initialize cast first.');
    return;
  }

  let contentType = 'video/mp4';
  let contentUrl = url;
  
  // Handle YouTube URLs
  if (url.includes('youtube.com') || url.includes('youtu.be')) {
    let videoId = '';
    if (url.includes('v=')) {
      videoId = url.split('v=')[1].split('&')[0];
    } else if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1].split('?')[0];
    }
    
    if (videoId) {
      // Use custom receiver to handle YouTube
      const customData = {
        mode: 'youtube',
        videoId: videoId,
        autoplay: true,
        controls: true
      };
      
      const mediaInfo = new chrome.cast.media.MediaInfo(
        window.location.origin + '/receiver.html',
        'text/html'
      );
      
      const request = new chrome.cast.media.LoadRequest(mediaInfo);
      request.customData = customData;
      
      castSession.loadMedia(request).then(
        () => {
          console.log('YouTube video cast successfully');
          alert('YouTube video casting!');
        },
        (error) => {
          console.error('Error casting YouTube:', error);
          alert('Error casting YouTube video');
        }
      );
      return;
    }
  }
  
  // Detect content type from URL
  if (url.match(/\.(jpeg|jpg|gif|png|bmp|webp)$/i)) {
    contentType = 'image/jpeg';
  } else if (url.match(/\.(mp3|wav|ogg)$/i)) {
    contentType = 'audio/mpeg';
  } else if (url.match(/\.(webm)$/i)) {
    contentType = 'video/webm';
  } else if (url.match(/\.(m3u8)$/i)) {
    contentType = 'application/x-mpegURL';
  }

  const mediaInfo = new chrome.cast.media.MediaInfo(contentUrl, contentType);
  const request = new chrome.cast.media.LoadRequest(mediaInfo);

  // Add autoplay and loop for better user experience
  request.autoplay = true;
  request.repeatMode = 'all';

  castSession.loadMedia(request).then(
    () => {
      console.log('Media loaded successfully');
      alert('Content cast successfully!');
    },
    (error) => {
      console.error('Error loading media:', error);
      alert('Error casting content. Check URL format and ensure content is publicly accessible via HTTPS.');
    }
  );
}

// Preview content before casting
document.getElementById('singleUrl').addEventListener('blur', function() {
  const url = this.value.trim();
  const preview = document.getElementById('contentPreview');
  
  if (!url) {
    preview.innerHTML = '<p>Content preview will appear here</p>';
    return;
  }
  
  preview.innerHTML = '<p>Analyzing content...</p>';
  
  // Handle YouTube preview
  if (url.includes('youtube.com') || url.includes('youtu.be')) {
    let videoId = '';
    if (url.includes('v=')) {
      videoId = url.split('v=')[1].split('&')[0];
    } else if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1].split('?')[0];
    }
    
    if (videoId) {
      preview.innerHTML = `
        <div style="text-align: center;">
          <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" style="max-width: 100%; border-radius: 4px;">
          <p style="margin-top: 10px;">YouTube Video Preview</p>
        </div>
      `;
    }
  } 
  // Handle image preview
  else if (url.match(/\.(jpeg|jpg|gif|png|bmp|webp)$/i)) {
    preview.innerHTML = `<img src="${url}" alt="Image preview">`;
  }
  // Handle video preview
  else if (url.match(/\.(mp4|webm|ogg|m3u8)$/i)) {
    preview.innerHTML = `<video controls><source src="${url}" type="video/mp4">Your browser does not support the video tag.</video>`;
  }
  // Generic preview
  else {
    preview.innerHTML = `<p>Content type will be determined at cast time</p>`;
  }
});

function castGrid() {
  const inputs = document.querySelectorAll('#gridInputs input');
  const urls = [];
  
  inputs.forEach(input => {
    if (input.value.trim()) {
      urls.push(input.value.trim());
    }
  });

  if (urls.length === 0) {
    alert('Please add at least one URL');
    return;
  }

  if (!castSession) {
    alert('No cast session. Please initialize cast first.');
    return;
  }

  const customData = {
    gridMode: 'pip9x9',
    urls: urls,
    timestamp: new Date().toISOString(),
    autoplay: true
  };

  const mediaInfo = new chrome.cast.media.MediaInfo(
    window.location.origin + '/receiver.html',
    'text/html'
  );
  
  const request = new chrome.cast.media.LoadRequest(mediaInfo);
  request.customData = customData;

  castSession.loadMedia(request).then(
    () => {
      console.log('Grid loaded successfully');
      alert(`Grid cast successfully with ${urls.length} sources!`);
    },
    (error) => {
      console.error('Error loading grid:', error);
      alert('Error casting grid. Ensure receiver.html is properly hosted and accessible.');
    }
  );
}

function stopCasting() {
  if (castSession) {
    castSession.endSession(true);
  }
}

function addGridInput() {
  const container = document.getElementById('gridInputs');
  const index = container.children.length;
  const div = document.createElement('div');
  div.className = 'grid-input';
  div.innerHTML = `
    <input type="text" placeholder="URL for Tile ${index + 1}">
    <button onclick="this.parentElement.remove()" style="width:40px">✕</button>
  `;
  container.appendChild(div);
}

function connectToRemote() {
  const host = document.getElementById('remoteHost').value.trim();
  const port = document.getElementById('remotePort').value;
  
  if (!host) {
    alert('Please enter a hostname or IP address');
    return;
  }
  
  const context = cast.framework.CastContext.getInstance();
  context.setOptions({
    receiverApplicationId: 'YOUR_CUSTOM_APP_ID',
    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
  });
  
  initializeCast();
  alert('Attempting to connect to remote device. Ensure remote access is enabled on your Google TV and the network is properly configured.');
}

// Load all data from JSON files
async function loadData() {
  try {
    // Load content library
    const libraryResponse = await fetch('content-library.json');
    const libraryData = await libraryResponse.json();
    contentLibrary = libraryData.items || [];
    populateContentLibrary();
    
    // Load playlists
    const playlistsResponse = await fetch('playlists.json');
    const playlistsData = await playlistsResponse.json();
    playlists = playlistsData.playlists || [];
    populatePlaylists();
    
    // Load zones
    const zonesResponse = await fetch('zones.json');
    const zonesData = await zonesResponse.json();
    zones = zonesData.zones || [];
    populateZones();
    
  } catch (error) {
    console.error('Error loading data:', error);
    alert('Error loading configuration data. Please check that all JSON files are present and accessible.');
  }
}

function populateContentLibrary() {
  const select = document.getElementById('contentLibrary');
  select.innerHTML = '<option value="">Select from Library</option>';
  
  contentLibrary.forEach(item => {
    const option = document.createElement('option');
    option.value = item.url;
    option.textContent = item.name;
    select.appendChild(option);
  });
}

function populatePlaylists() {
  const select = document.getElementById('playlistSelect');
  select.innerHTML = '<option value="">Select Playlist</option>';
  
  playlists.forEach(playlist => {
    const option = document.createElement('option');
    option.value = playlist.name;
    option.textContent = playlist.name;
    select.appendChild(option);
  });
}

function populateZones() {
  const select = document.getElementById('targetZone');
  select.innerHTML = '<option value="all">All Devices</option>';
  
  zones.forEach(zone => {
    const option = document.createElement('option');
    option.value = zone.name;
    option.textContent = zone.name;
    select.appendChild(option);
  });
}

function loadFromLibrary() {
  const select = document.getElementById('contentLibrary');
  const url = select.value;
  
  if (!url) {
    alert('Please select an item from the library');
    return;
  }
  
  // Add to first empty grid input or create new one
  const inputs = document.querySelectorAll('#gridInputs input');
  let added = false;
  
  inputs.forEach(input => {
    if (!input.value.trim() && !added) {
      input.value = url;
      added = true;
    }
  });
  
  if (!added) {
    addGridInput();
    const inputs = document.querySelectorAll('#gridInputs input');
    inputs[inputs.length - 1].value = url;
  }
  
  alert('Content added to grid!');
}

function loadPlaylist() {
  const select = document.getElementById('playlistSelect');
  const name = select.value;
  if (!name) {
    alert('Select a playlist to load');
    return;
  }
  
  const playlist = playlists.find(p => p.name === name);
  if (playlist) {
    // Clear and repopulate grid inputs
    const container = document.getElementById('gridInputs');
    container.innerHTML = '';
    
    playlist.gridUrls.forEach(url => {
      const div = document.createElement('div');
      div.className = 'grid-input';
      div.innerHTML = `
        <input type="text" value="${url}" placeholder="URL for Tile">
        <button onclick="this.parentElement.remove()" style="width:40px">✕</button>
      `;
      container.appendChild(div);
    });
    
    alert(`Playlist "${name}" loaded!`);
  }
}

function savePlaylist() {
  const name = prompt('Enter playlist name:');
  if (!name) return;
  
  const urls = Array.from(document.querySelectorAll('#gridInputs input'))
    .map(i => i.value.trim())
    .filter(v => v);
  
  if (urls.length === 0) {
    alert('Cannot save empty playlist');
    return;
  }
  
  // In production, you would send this to a server
  // For demo, show success
  alert(`Playlist "${name}" would be saved to server!`);
}

function scheduleCast() {
  const name = document.getElementById('scheduleName').value.trim();
  const start = document.getElementById('startTime').value;
  const end = document.getElementById('endTime').value;
  const zone = document.getElementById('targetZone').value;
  
  if (!name || !start || !end) {
    alert('Please fill all schedule fields');
    return;
  }
  
  const gridUrls = Array.from(document.querySelectorAll('#gridInputs input'))
    .map(i => i.value.trim())
    .filter(v => v);
  
  const schedule = {
    name,
    start,
    end,
    zone,
    gridUrls,
    scheduledAt: new Date().toISOString()
  };
  
  // In production, you would send this to a server
  alert(`Schedule "${name}" would be saved to server and executed from ${start} to ${end} on ${zone}!`);
}

// Initialize with 3 inputs
for (let i = 0; i < 3; i++) {
  addGridInput();
}

// Load all data on startup
window.onload = function() {
  loadData();
};
</script>
</body>
</html>
