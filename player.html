<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADAM Signage Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
body {
  display: grid;
  grid-template-columns: repeat(9, 1fr);
  grid-gap: 4px;
  margin: 0;
  background: #000;
}
.tile-container {
  width: 100%;
  position: relative;
  background: #000;
  border-radius: 6px;
  overflow: hidden;
}
.tile-container video,
.tile-container iframe,
.tile-container img {
  width: 100%;
  height: auto;
  display: block;
}
.fullscreen {
  position: fixed !important;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
}
</style>
</head>
<body>
<script>
const channel = new BroadcastChannel('signage-control');
const tilesData = [];
const tileElements = [];
let playlistData = {};

// ---------------- Create 9x9 Tiles ----------------
for(let i=0;i<81;i++){
  const container = document.createElement('div');
  container.className = 'tile-container';
  document.body.appendChild(container);
  tileElements.push(container);

  // Assign zones/languages
  const zone = i < 27 ? 'Lobby' : (i < 54 ? 'Shop' : 'Conference');
  const language = i % 2 === 0 ? 'en' : 'hi';
  tilesData.push({ zone, language });
}

// ---------------- Load Playlist ----------------
async function loadPlaylist() {
  try {
    const res = await fetch('playlists.json');
    playlistData = await res.json();
  } catch(e) {
    console.error('Failed to load playlist', e);
  }
}
loadPlaylist();

// ---------------- Scheduler ----------------
function getCurrentContent(tile) {
  const zoneData = playlistData[tile.zone];
  if(!zoneData) return null;
  const langData = zoneData[tile.language] || [];
  const now = new Date();
  const curMinutes = now.getHours() * 60 + now.getMinutes();
  for(let item of langData){
    const [sh, sm] = item.start.split(':').map(Number);
    const [eh, em] = item.end.split(':').map(Number);
    const startMin = sh*60 + sm;
    const endMin = eh*60 + em;
    if(curMinutes >= startMin && curMinutes < endMin) return item;
  }
  return null;
}

// ---------------- Load Content ----------------
function loadContent(container, item){
  if(!item) return;
  container.innerHTML = ''; // clear previous content
  if(item.type==='hls'){
    const video = document.createElement('video');
    video.autoplay = true;
    video.muted = true;
    video.playsInline = true;
    container.appendChild(video);
    if(Hls.isSupported()){
      const hls = new Hls();
      hls.loadSource(item.url);
      hls.attachMedia(video);
    } else {
      video.src = item.url;
    }
  } else if(item.type==='youtube'){
    const iframe = document.createElement('iframe');
    iframe.src = normalizeYouTubeUrl(item.url);
    iframe.width = container.offsetWidth;
    iframe.height = container.offsetHeight;
    iframe.allow = "autoplay; encrypted-media";
    iframe.frameBorder = 0;
    container.appendChild(iframe);
  } else if(item.type==='image'){
    const img = document.createElement('img');
    img.src = item.url;
    container.appendChild(img);
  }
}

// ---------------- YouTube URL Normalization ----------------
function normalizeYouTubeUrl(url){
  if(url.includes("youtube.com/watch?v=")){
    const id = url.split("v=")[1].split("&")[0];
    return `https://www.youtube.com/embed/${id}?autoplay=1&mute=1`;
  } else if(url.includes("youtu.be/")){
    const id = url.split("youtu.be/")[1];
    return `https://www.youtube.com/embed/${id}?autoplay=1&mute=1`;
  }
  return url;
}

// ---------------- Update Scheduler ----------------
function updateTiles(){
  tilesData.forEach((tile,i)=>{
    const item = getCurrentContent(tile);
    if(item) loadContent(tileElements[i], item);
  });
}
setInterval(updateTiles, 10000); // every 10s
updateTiles();

// ---------------- BroadcastChannel ----------------
channel.onmessage = e=>{
  const data = e.data;
  if(data.action==='play' && data.index!==undefined){
    loadContent(tileElements[data.index], { url:data.url, type:'video' });
  } else if(data.action==='broadcast'){
    tileElements.forEach(t=>loadContent(t, { url:data.url, type:'video' }));
  } else if(data.action==='clear'){
    tileElements.forEach(t=>{ t.innerHTML=''; });
  } else if(data.action==='fullscreen' && data.index!==undefined){
    const el = tileElements[data.index].firstChild;
    if(el){
      if(!el.classList.contains('fullscreen')) el.classList.add('fullscreen');
      else el.classList.remove('fullscreen');
    }
  }
};
</script>
</body>
</html>
