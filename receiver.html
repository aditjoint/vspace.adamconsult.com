<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADAM Signage Receiver</title>
<script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
body, html { 
  margin: 0; 
  padding: 0; 
  width: 100%; 
  height: 100%; 
  overflow: hidden; 
  background: #000; 
}
.grid-container { 
  display: grid; 
  grid-template-columns: repeat(9, 1fr); 
  grid-template-rows: repeat(9, 1fr); 
  width: 100%; 
  height: 100%; 
  gap: 2px; 
}
.grid-item { 
  background: #111; 
  position: relative; 
  overflow: hidden; 
}
.grid-item video, 
.grid-item img, 
.grid-item iframe { 
  width: 100%; 
  height: 100%; 
  object-fit: contain; 
}
.grid-item::after {
  content: attr(data-index);
  position: absolute;
  bottom: 4px;
  right: 4px;
  background: rgba(0,0,0,0.8);
  color: #0d6efd;
  font-size: 12px;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: monospace;
}
#fullscreen { 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: #000; 
  z-index: 1000; 
  display: none; 
}
#fullscreen video,
#fullscreen img,
#fullscreen iframe {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
</style>
</head>
<body>
<div class="grid-container" id="grid"></div>
<div id="fullscreen"></div>

<script>
const context = cast.framework.CastReceiverContext.getInstance();
const playerManager = context.getPlayerManager();
const grid = document.getElementById('grid');
const tiles = [];
const fullscreen = document.getElementById('fullscreen');

// Create 9x9 grid
for (let i = 0; i < 81; i++) {
  const tile = document.createElement('div');
  tile.className = 'grid-item';
  tile.id = `tile-${i}`;
  tile.setAttribute('data-index', i + 1);
  grid.appendChild(tile);
  tiles.push(tile);
}

playerManager.setMessageInterceptor(cast.framework.messages.MessageType.LOAD, request => {
  console.log('Load request:', request);
  
  if (request.customData && request.customData.gridMode === 'pip9x9') {
    tiles.forEach(tile => tile.innerHTML = '');
    
    if (request.customData.urls && Array.isArray(request.customData.urls)) {
      request.customData.urls.forEach((url, index) => {
        if (index < 81) {
          loadContent(tiles[index], url);
        }
      });
    }
  } else if (request.media && request.media.contentId) {
    tiles.forEach(tile => tile.innerHTML = '');
    fullscreen.style.display = 'block';
    loadContent(fullscreen, request.media.contentId);
  }
  
  return request;
});

playerManager.setMessageInterceptor(cast.framework.messages.MessageType.STOP, request => {
  tiles.forEach(tile => tile.innerHTML = '');
  fullscreen.style.display = 'none';
  fullscreen.innerHTML = '';
  return request;
});

function loadContent(container, url) {
  container.innerHTML = '';
  
  if (url.includes('youtube.com') || url.includes('youtu.be')) {
    let videoId = '';
    if (url.includes('v=')) {
      videoId = url.split('v=')[1].split('&')[0];
    } else if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1].split('?')[0];
    }
    
    if (videoId) {
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0`;
      iframe.allow = 'autoplay; encrypted-media';
      iframe.frameBorder = '0';
      container.appendChild(iframe);
    }
  } else if (url.match(/\.(jpeg|jpg|gif|png|bmp|webp)$/i)) {
    const img = document.createElement('img');
    img.src = url;
    container.appendChild(img);
  } else if (url.match(/\.(mp4|webm|ogg)$/i)) {
    const video = document.createElement('video');
    video.src = url;
    video.autoplay = true;
    video.muted = true;
    video.loop = true;
    container.appendChild(video);
  } else if (url.includes('.m3u8')) {
    const video = document.createElement('video');
    video.autoplay = true;
    video.muted = true;
    video.loop = true;
    container.appendChild(video);
    
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = url;
    }
  } else {
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframe.allow = 'autoplay';
    iframe.frameBorder = '0';
    container.appendChild(iframe);
  }
}

context.start();
</script>
</body>
</html>
